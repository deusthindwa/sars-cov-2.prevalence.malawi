#written by Deus
#01/08/2022
#pneumococcal carriage ad serotype dynamics in HIV-infected adults in the infant PCV era

#====================================================================
# CONTINUOUS-TIME TIME-NONHOMOGENEOUS MARKOV MODEL (SEROTYPE-SPECIFIC)
#====================================================================

# show transition frequency
spn_model <- arrange(spn_model, pid, dys)
statetable.msm(sstate, pid, data = spn_model)

#initiate transition intensity matrix Q
spn_Qmatrix <-  rbind(c(0.26, 0.26, 0.26, 0.26, 0.26, 0.26, 0.26, 0.26, 0.26, 0.26, 0.26, 0.26, 0.26, 0.26, 0.26),
                      c(0.26, 0.26, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00),
                      c(0.26, 0.00, 0.26, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00),
                      c(0.26, 0.00, 0.00, 0.26, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00),
                      c(0.26, 0.00, 0.00, 0.00, 0.26, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00),
                      c(0.26, 0.00, 0.00, 0.00, 0.00, 0.26, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00),
                      
                      c(0.26, 0.00, 0.00, 0.00, 0.00, 0.00, 0.26, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00),
                      c(0.26, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.26, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00),
                      c(0.26, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.26, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00),
                      c(0.26, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.26, 0.00, 0.00, 0.00, 0.00, 0.00),
                      c(0.26, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.26, 0.00, 0.00, 0.00, 0.00),
                      c(0.26, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.26, 0.00, 0.00, 0.00),
                      c(0.26, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.26, 0.00, 0.00),
                      c(0.26, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.26, 0.00),
                      c(0.26, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.26)
)

rownames(spn_Qmatrix) <- c("clear", "3", "4", "6A/6B", "7B/C", "8", "9V", "11", "15", "17", "19B/C", "19A/19F", "23A/B", "oVT", "oNVT")
colnames(spn_Qmatrix) <- c("clear", "3", "4", "6A/6B", "7B/C", "8", "9V", "11", "15", "17", "19B/C", "19A/19F", "23A/B", "oVT", "oNVT")
spn_Qmatrix

# #run the Markov model
spn_modelfitSc5 <- msm(sstate ~ dys, subject = pid, data = spn_model,
                     qmatrix = spn_Qmatrix,
                     #pci = c(60, 120, 180, 240),
                     opt.method = "bobyqa", control = list(maxfun = 100000000))

